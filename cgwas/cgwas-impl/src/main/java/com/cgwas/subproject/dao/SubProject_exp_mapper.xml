<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- @author yangjun -->
<mapper namespace="com.cgwas.subproject.dao">
	<sql id="columnsAs">
		t1.id, t1.project_id,t1.sub_parent_project_id, t1.total,
		t1.project_status_id,
		t1.duration, t1.name,t1.is_parent, t1.cover_path,
		t1.introduce,
		t1.project_folder,
		t1.creater_name, t1.user_id,
		t1.create_time,
		t1.modified_time,
		t1.begin_time, t1.end_time
	</sql>
	<resultMap type="com.cgwas.subproject.entity.SubProjectVo"
		id="projectDetailsMap">
		<id property="id" column="id" />
		<association property="company" column="company_id" javaType="com.cgwas.company.entity.Company" select="getCompanyById"/>
		<association property="projectStatus" column="project_status_id"
			javaType="com.cgwas.projectStatus.entity.ProjectStatusVo" select="getProjectStatusVoById" />
		<collection property="directors" column="id" javaType="arrayList"
			ofType="com.cgwas.director.entity.DirectorVo" select="getDirectorsById"></collection>
		<collection property="principals" column="id" javaType="arrayList"
			ofType="com.cgwas.principal.entity.PrincipalVo" select="getPrincipalsById"></collection>
	</resultMap>
	<select id="getPrincipalsById" resultType="com.cgwas.principal.entity.PrincipalVo">
		select p1.* from
		p_principal p1 left join p_project_principal p2 on
		p1.id=p2.principal_id where p2.project_id=#{id} and
		p2.is_parent_project=0
	</select>
	<select id="getDirectorsById" resultType="com.cgwas.director.entity.DirectorVo">
		select p1.* from
		p_director p1 left join p_project_director p2 on
		p1.id=p2.director_id
		where p2.project_id=#{id} and p2.is_parent_project=0
	</select>
	<select id="getProjectStatusVoById" resultType="com.cgwas.projectStatus.entity.ProjectStatusVo">
		select * from
		p_project_status where id=#{project_status_id}
	</select>
	<select id="getProjectDetails" resultMap="projectDetailsMap">
		select
		<include refid="columns" />
		from p_sub_project where id=#{project_id}
	</select>
	<select id="getProjectTypeVoById" resultType="com.cgwas.projectType.entity.ProjectTypeVo">
		select * from
		p_project_type where id=#{project_type_id}
	</select>
	<select id="getResolutionCompanyById"
		resultType="com.cgwas.resolutionCompany.entity.ResolutionCompanyVo">
		select * from p_resolution_company where
		id=#{resolution_id}
	</select>
	<select id="getFrameRateCompanyVoById"
		resultType="com.cgwas.frameRateCompany.entity.FrameRateCompanyVo">
		select * from p_frame_rate_company where
		id=#{frame_rate_id}
	</select>
	<resultMap type="com.cgwas.subproject.entity.SubProjectVo"
		id="subProjectVoMap">
		<id property="id" column="id" />
		<association property="company" column="company_id"
			javaType="com.cgwas.company.entity.Company" select="getCompanyById"></association>
		<association property="projectStatus" column="project_status_id"
			javaType="com.cgwas.projectStatus.entity.ProjectStatusVo" select="getProjectStatusVoById"></association>
		<association property="projectType" column="project_type_id"
			javaType="com.cgwas.projectType.entity.ProjectTypeVo" select="getProjectTypeVoById"></association>
		<collection property="companySoftwares" column="id"
			javaType="arrayList" ofType="com.cgwas.companySoftware.entity.CompanySoftwareVo"
			select="getSoftwaresById"></collection>
		<collection property="directors" column="id" javaType="arrayList"
			ofType="com.cgwas.director.entity.DirectorVo" select="getDirectorsById"></collection>
		<collection property="principals" column="id" javaType="arrayList"
			ofType="com.cgwas.principal.entity.PrincipalVo" select="getPrincipalsById"></collection>
	</resultMap>
	<select id="getSoftwaresById" resultType="com.cgwas.companySoftware.entity.CompanySoftwareVo">
		select p1.* from
		p_company_software p1 left join p_company_software_model p2
		on
		p1.id=p2.company_software_id where p2.for_id=#{id} and
		p2.model_type='project'
	</select>
	<select id="getCompanyById" resultType="com.cgwas.company.entity.Company">
		select id,company_name
		from u_company where id=#{company_id}
	</select>
	<select id="getDataList" resultMap="subProjectVoMap">
		select distinct t1.*,p2.content,u.username
		FROM p_sub_project t1
		LEFT
		JOIN p_project_status p2 ON t1.project_status_id=p2.id
		LEFT JOIN u_user
		u ON t1.user_id=u.id
		LEFT JOIN p_project_director p6 ON
		t1.id=p6.project_id
		LEFT JOIN p_director p7 ON p6.director_id=p7.id
		<where>
			<if test="flag==1">
				and t1.project_id=#{id}
			</if>
			<if test="flag==0">
				and t1.sub_parent_project_id=#{id}
			</if>
			<if
				test="psearch.field=='content_status' and psearch.search!=null and psearch.search!=''">
				and p2.content like "%"#{psearch.search}"%"
			</if>
			<if
				test="psearch.field=='begin_time' and psearch.search!=null and psearch.search!=''">
				and t1.begin_time like "%"#{psearch.search}"%"
			</if>
			<if
				test="psearch.field=='total' and psearch.search!=null and psearch.search!=''">
				and t1.total=#{psearch.search}
			</if>
			<if
				test="psearch.field=='username' and psearch.search!=null and psearch.search!=''">
				and u.username like "%"#{psearch.search}"%"
			</if>
			<if
				test="psearch.field=='director_name' and psearch.search!=null and psearch.search!=''">
				and p7.director_name like "%"#{psearch.search}"%"
			</if>
		</where>
		<if test="psearch.field=='content_status' and  psearch.sort=='asc'">
			order by to_pinyin(p2.content) asc
		</if>
		<if test="psearch.field=='content_status' and psearch.sort=='desc'">
			order by to_pinyin(p2.content) desc
		</if>
		<if test="psearch.field=='begin_time' and  psearch.sort=='asc'">
			order by t1.begin_time asc
		</if>
		<if test="psearch.field=='begin_time' and psearch.sort=='desc'">
			order by t1.begin_time desc
		</if>
		<if test="psearch.field=='total' and psearch.sort=='asc'">
			order by t1.total asc
		</if>
		<if test="psearch.field=='total' and psearch.sort=='desc'">
			order by t1.total desc
		</if>
		<if test="psearch.field=='username' and psearch.sort=='asc'">
			order by to_pinyin(u.username) asc
		</if>
		<if test="psearch.field=='username' and psearch.sort=='desc'">
			order by to_pinyin(u.username) desc
		</if>
	</select>
	<select id="selectSubProjectPage" resultMap="subProjectVoMap">
		select distinct t1.*,p2.content,u1.name
		FROM p_sub_project t1
		LEFT
		JOIN p_project_status p2 ON t1.project_status_id=p2.id
		LEFT JOIN u_user
		u ON t1.user_id=u.id 
		left join u_user_info u1 on u1.user_id=u.id
		LEFT JOIN p_project_director p6 ON
		t1.id=p6.project_id
		LEFT JOIN p_director p7 ON p6.director_id=p7.id
		<where>
		    t1.company_id=#{psearch.company_id}
			<if test="psearch.flag==1">
				and t1.project_id=#{psearch.id}
			</if>
			<if test="psearch.flag==0">
				and t1.sub_parent_project_id=#{psearch.id}
			</if>
			<if
				test="psearch.field=='content_status' and psearch.search!=null and psearch.search!=''">
				and p2.content like "%"#{psearch.search}"%"
			</if>
			<if
				test="psearch.field=='begin_time' and psearch.search!=null and psearch.search!=''">
				and t1.begin_time like "%"#{psearch.search}"%"
			</if>
			<if
				test="psearch.field=='total' and psearch.search!=null and psearch.search!=''">
				and t1.total=#{psearch.search}
			</if>
			<if
				test="psearch.field=='username' and psearch.search!=null and psearch.search!=''">
				and u1.name like "%"#{psearch.search}"%"
			</if>
			<if
				test="psearch.field=='director_name' and psearch.search!=null and psearch.search!=''">
				and p7.director_name like "%"#{psearch.search}"%"
			</if>
		</where>
		<if test="psearch.field=='content_status' and  psearch.sort=='asc'">
			order by to_pinyin(p2.content) asc
		</if>
		<if test="psearch.field=='content_status' and psearch.sort=='desc'">
			order by to_pinyin(p2.content) desc
		</if>
		<if test="psearch.field=='begin_time' and  psearch.sort=='asc'">
			order by t1.begin_time asc
		</if>
		<if test="psearch.field=='begin_time' and psearch.sort=='desc'">
			order by t1.begin_time desc
		</if>
		<if test="psearch.field=='total' and psearch.sort=='asc'">
			order by t1.total asc
		</if>
		<if test="psearch.field=='total' and psearch.sort=='desc'">
			order by t1.total desc
		</if>
		<if test="psearch.field=='username' and psearch.sort=='asc'">
			order by to_pinyin(u1.name) asc
		</if>
		<if test="psearch.field=='username' and psearch.sort=='desc'">
			order by to_pinyin(u1.name) desc
		</if>
		limit #{firstrownum}, #{limit}
	</select>
	<select id="selectSubProjectCount" resultType="java.lang.Long">
		select count(DISTINCT t1.id)
		FROM p_sub_project t1
		LEFT JOIN
		p_project_status p2 ON t1.project_status_id=p2.id
		LEFT JOIN u_user u ON
		t1.user_id=u.id
		left join u_user_info u1 on u1.user_id=u.id
		LEFT JOIN p_project_director p6 ON t1.id=p6.project_id
		LEFT JOIN p_director p7 ON p6.director_id=p7.id
		<where>
		 t1.company_id=#{psearch.company_id}
			<if test="psearch.flag==1">
				and t1.project_id=#{psearch.id}
			</if>
			<if test="psearch.flag==0">
				and t1.sub_parent_project_id=#{psearch.id}
			</if>
			<if
				test="psearch.field=='content_status' and psearch.search!=null and psearch.search!=''">
				and p2.content like "%"#{psearch.search}"%"
			</if>
			<if
				test="psearch.field=='begin_time' and psearch.search!=null and psearch.search!=''">
				and t1.begin_time like "%"#{psearch.search}"%"
			</if>
			<if
				test="psearch.field=='total' and psearch.search!=null and psearch.search!=''">
				and t1.total=#{psearch.search}
			</if>
			<if
				test="psearch.field=='username' and psearch.search!=null and psearch.search!=''">
				and u1.name like "%"#{psearch.search}"%"
			</if>
			<if
				test="psearch.field=='director_name' and psearch.search!=null and psearch.search!=''">
				and p7.director_name like "%"#{psearch.search}"%"
			</if>
		</where>
	</select>
	<select id="getSubProjectById" resultMap="subProjectMap">
		select
		<include refid="columns" />
		from p_sub_project
		where id=#{id}
	</select>
	<select id="getScreenwriterById" resultType="com.cgwas.screenwriter.entity.ScreenwriterVo">
		select p1.* from
		p_screenwriter p1 left join p_project_screenwriter p2 on
		p1.id=p2.screenwriter_id where p2.project_id=#{id} and
		p2.is_parent_project=0
	</select>
	<resultMap type="com.cgwas.subproject.entity.SubProjectVo"
		id="subProjectMap">
		<id property="id" column="id" />
		<association property="projectStatus" column="project_status_id"
			javaType="com.cgwas.projectStatus.entity.ProjectStatusVo" select="getProjectStatusVoById"></association>
		<collection property="directors" column="id" javaType="arrayList"
			ofType="com.cgwas.director.entity.DirectorVo" select="getDirectorsById"></collection>
		<collection property="principals" column="id" javaType="arrayList"
			ofType="com.cgwas.principal.entity.PrincipalVo" select="getPrincipalsById"></collection>
		<collection property="screenwriters" column="id" javaType="arrayList"
			ofType="com.cgwas.screenwriter.entity.ScreenwriterVo" select="getScreenwriterById"></collection>
	</resultMap>
</mapper>