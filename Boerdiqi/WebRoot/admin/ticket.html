<!DOCTYPE HTML>
<html>
<head>
<title> 搜索表单</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link href="../static/assets3/css/bs3/dpl-min.css" rel="stylesheet" type="text/css" />
<link href="../static/assets3/css/bs3/bui-min.css" rel="stylesheet" type="text/css" />
<!-- <link href="../static/assets/css/dpl-min.css" rel="stylesheet" type="text/css" />
<link href="../static/assets/css/bui-min.css" rel="stylesheet" type="text/css" /> -->
<link href="../static/assets/css/page-min.css" rel="stylesheet" type="text/css" />
<style type="text/css">
[v-cloak] {
    display: none;
}
</style>
</head>
<body>
  <div class="container">
  <div class="row">
      <form id="searchForm" class="form-horizontal span24">
        <div class="row">
          <div class="control-group span8">
            <label class="control-label">优惠券名称</label>
            <div class="controls">
              <input type="text" class="control-text" name="name" placeholder="关键字">
              <input type="text" name="aaa" style="display: none;">
            </div>
          </div>
      </div>
          <div class="span3 offset" style="float:left;margin-left:300px;margin-top:-48px">
            <button  type="button" id="btnSearch" class="button button-primary">搜索</button>
          </div>
        </div>
      </form>
    </div>
    <div class="search-grid-container">
      <div id="grid"></div>
    </div>

  </div>
  <div id="content" class="hide">
     <form id="J_Form" class="form-horizontal" action="" method="post">
       <input type="hidden" name="id">
       <div class="row">
         <div class="control-group span8">
           <label class="control-label"><s>*</s>优惠券名称</label>
           <div class="controls">
             <input name="name" type="text" data-tip="{text : '优惠券名称'}" data-rules="{required:true}" class="input-normal control-text">
           </div>
         </div>
       </div>
       <div class="row">
         <div class="control-group span8">
           <label class="control-label"><s>*</s>发放总量</label>
           <div class="controls">
             <input name="num" type="text" data-tip="{text : '发放总量'}" data-rules="{required:true,number:true,min:0}" class="input-normal control-text">
           </div>
         </div>
       </div>
       <div class="row">
         <div class="control-group span8">
           <label class="control-label"><s>*</s>面值</label>
           <div class="controls">
             <input name="price"  id="price" type="text" data-tip="{text : '面值'}" data-rules="{required:true,number:true,min:0}" class="input-normal control-text">
           </div>
         </div>
       </div>
       <div class="row">
         <div class="control-group span8">
           <label class="control-label"><s>*</s>使用门槛(满XX可用)</label>
           <div class="controls">
             <input name="minprice"  id="minprice" type="text" data-tip="{text : '使用门槛(满XX可用)'}" data-rules="{required:true,number:true,min:0, mp:0}" class="input-normal control-text">
           </div>
         </div>
       </div>
       <div class="row">
         <div class="control-group span8">
           <label class="control-label"><s>*</s>每人限领/张(0为不限)</label>
           <div class="controls">
		      <input name="unum" id="unum" type="text" data-tip="{text : '0为不限张数'}"  data-rules="{required:true,number:true,min:0}" class="input-normal control-text">
           </div>
         </div>
       </div>
      <div class="row">
	      <div class="control-group">
	        <label class="control-label"><s>*</s>时间范围</label>
	        <div class="controls bui-form-group" data-rules="{dateRange : true}" data-messages="{dateRange : '过期时间不能小于生效时间！'}" >
	          <input name="start_time"  id="start_time" data-tip="{text : '生效时间'}" data-rules="{required:true}" data-messages="{required : '生效时间不能为空！'}" class="input-small calendar" type="text"><label>&nbsp;-&nbsp;</label>
	          <input name="end_time" id="end_time" data-tip="{text : '过期时间'}" data-rules="{required:true}" data-messages="{required : '过期时间不能为空！'}" class="input-small calendar" type="text">
	        </div>
	      </div>
      </div>
      <div class="row">
          <div class="control-group span15">
            <label class="control-label">使用说明</label>
            <div class="controls control-row3">
              <textarea data-tip="{text : '填写优惠券使用的详细说明'}" name="details" type="text"></textarea>
            </div>
          </div>
	   </div>
     </form>
   </div>
<script type="text/javascript" src="../static/common/jquery.min-2.1.3.js"></script>
<script type="text/javascript" src="../static/layer/layer.js"></script>
<script type="text/javascript" src="../static/assets/js/bui.js"></script>
<script type="text/javascript" src="../static/assets/js/config.js"></script>
<script type="text/javascript">
BUI.use(['common/search'],function(Search,Grid,Data){

	var Form = BUI.Form;
    Form.Rules.add({
		name : 'mp',  //规则名称
		msg : '使用门槛不能小于面值！',//默认显示的错误信息
		validator : function(value,baseValue,formatMsg){ //验证函数，验证值、基准值、格式化后的错误信息
	   		var price=$("[name='price']").val();
			if(parseFloat(value) < parseFloat(price)){
	       		return formatMsg;
			}
		}
	}); 

    var Grid = BUI.Grid,
      columns = [
          {title:'优惠券名称',width : 50,dataIndex:'name',elCls : 'center'},
          {title:'发放总量',width : 50,dataIndex:'num',elCls : 'center'},
          {title:'面值',width : 50,dataIndex:'price',elCls : 'center'},
          {title:'使用门槛',width : 50,dataIndex:'minprice',elCls : 'center'},
          {title:'每人限领/张',width : 50,dataIndex:'unum',elCls : 'center'},
          {title:'时间范围',width : 150,dataIndex:'',elCls : 'center',renderer : function(value,obj){
				var st="生效时间:"+obj.start_time+"<br>",et = "过期时间:"+obj.end_time;
            	return st+et;
          }},
          {title:'状态',width : 50,dataIndex:'',elCls : 'center',renderer : function(value,obj){
				var flag="",state = "";
				if (obj.flag==1) {
					flag="未开始<br>";
				}else if (obj.flag==2) {
					flag="进行中<br>";
					if (obj.state==1) {
						state="可领取";
					}else {
						state="已领完";
					}
				}else if (obj.flag==3) {
					flag="已结束<br>";
				}
          	return flag+state;
		  }},
          {title:'使用说明',width : 150,dataIndex:'details',elCls : 'center'},
          {title:'操作',width : 80,dataIndex:'',elCls : 'center',renderer : function(value,obj){
				var updStr="<span class=\"grid-command btn-edit\">编辑</span>&nbsp;&nbsp;&nbsp;&nbsp;",
				delStr = '<span class="grid-command btn-del" title="删除">删除</span>';
				return updStr+delStr;
          }}
        ],
   		editing = new Grid.Plugins.DialogEditing({
          contentId : 'content',
          //autoSave : true,
          triggerCls : 'btn-edit', 
          editor : {
        	  width : 400,
              title: '编辑',
              success : function(){
                var edtor = this,
                form = edtor.get('form'),
                editType = editing.get('editType'),//add 或者 edit
                url = ""; 
                if(editType == 'add'){ //可以根据编辑类型决定url
                  url = '../ticket/addTicket.do';
                }else if(editType == 'edit'){
                  url = '../ticket/updateTicket.do';
                }
                //检验
                form.valid();
                if(form.isValid()){
               		layer.load();
                  form.ajaxSubmit({ //表单异步提交
                    url : url,
                    success : function(data){
                      if(data.hasError){ //返回的数据是 {hasError : fasle,error : 'xxxx',field : 'xxx'},也可以是任意格式的数据如 ： {success : false,'error' : 'xxxxx'}
                    	  BUI.Message.Alert(data.errInfo,'warning');
                      }else{
	                        edtor.close();
                        	store.load();
                          BUI.Message.Alert(data.errInfo,function(){
                          },'info');
                      }
						layer.closeAll('loading');
                    },
                    error : function(XMLHttpRequest, textStatus, errorThrown) {
						layer.closeAll('loading');
						layer.msg("系统繁忙，请稍后"+XMLHttpRequest.status+","+XMLHttpRequest.readyState+","+textStatus);
					}
                  });
                }
              }
            }
        }),
	store = Search.createStore('../ticket/loadTicket.do',{
        proxy : {
          save : { //也可以是一个字符串，那么增删改，都会往那么路径提交数据，同时附加参数saveType
          },
          method : 'POST'
        },
        params : { //配置初始请求的参数
        },
        pageIndex :0,
        pageSize:10,
        autoSync : true //保存数据后，自动更新
      });
	function addFunction(){
		var newData = {unum : 0}; //标志是新增加的记录
		editing.add(newData,'new'); //添加记录后，直接编辑
	}

    function updFunction(){ 
        var selections = grid.getSelection();
        var ids = [];
        BUI.each(selections,function(selections){
          ids.push(selections.id);
        });

        if(ids.length>1){
          BUI.Message.Alert('只能选择一条记录','warning');
        }else if(ids.length<=0){
            BUI.Message.Alert('请选择要编辑的记录','warning');
        }else {
	        //alert(JSON.stringify(selections));
	        editing.edit(selections[0]);
		}
    }
    
    //删除操作
    function delFunction(){
      var selections = grid.getSelection();
      delItems(selections);
    }
    var btns=[ {text : '<i class="icon-plus"></i>新建',btnCls : 'button button-small',handler:addFunction},
         {text : '<i class="icon-edit"></i>编辑',btnCls : 'button button-small',handler:updFunction},
         {text : '<i class="icon-remove"></i>删除',btnCls : 'button button-small',handler : delFunction} ]
     var gridCfg = Search.createGridCfg(columns,{
         forceFit:true,
         emptyDataTpl : '<div class="centered"><img alt="Crying" src="http://img03.taobaocdn.com/tps/i3/T1amCdXhXqXXXXXXXX-60-67.png"><h2>查询的数据不存在</h2></div>',
		tbar : {
          items : btns
        },
        loadMask: true, //加载数据时显示屏蔽层
        plugins : [editing,BUI.Grid.Plugins.CheckSelection] // 插件形式引入多选表格
      });

    var  search = new Search({
        store : store,
        gridCfg : gridCfg
      }),
      grid = search.get('grid');
    
    editing.on('editorshow',function(ev){
        var type = ev.editType; //add ,edit
          //record = editing.get('record'); 
        if( type == 'add'){  //如果马上保存，通过 ev.editType == 'add' 来判断
         $("#start_time").removeAttr("disabled");
          $("#end_time").removeAttr("disabled");
        }else{
         $("#price").attr("readonly","readonly");
         $("#minprice").attr("readonly","readonly");
         $("#unum").attr("readonly","readonly");
         $("#start_time").attr("disabled","disabled");
          $("#end_time").attr("disabled","disabled");
        }
    });
    
    function delItems(items){
      var ids = [];
      BUI.each(items,function(item){
        ids.push(item.id);
      });
      if(ids.length){
        BUI.Message.Confirm('确认要删除选中的记录么？',function(){
        	$.ajax({
    			url : "../ticket/deleteTicket.do",
    			data : {"ids":ids.toString()},
    			dataType : "json",
    			type : "post",
    			async: true,
    			success : function(data) {
    				if (!data.hasError) {
    					store.load();
    				}else {
						BUI.Message.Alert(data.errInfo,'warning');
    				}
    			},
    			error : function(XMLHttpRequest, textStatus, errorThrown) {
    				BUI.Message.Alert("系统繁忙，请稍后"+XMLHttpRequest.status+","+XMLHttpRequest.readyState+","+textStatus,'warning');
    			}
    		}); 
        },'question');
      }else{
		BUI.Message.Alert("请选择记录",function(){},'warning');
      }
    }

    //监听事件，删除一条记录
    grid.on('cellclick',function(ev){
      var sender = $(ev.domTarget); //点击的Dom
      if(sender.hasClass('btn-del')){
        var record = ev.record;
        delItems([record]);
      }
    });
    
  });
  $(function(){
	  
  });
</script>

<body>
</html>  